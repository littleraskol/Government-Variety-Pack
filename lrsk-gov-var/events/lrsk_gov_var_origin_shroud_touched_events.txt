# Government Variety Pack
# Events - Shroud-Touched Origin
# Author: littleraskol

namespace = lrsk_gov_var_shroud_touched

# Sets initial tech progress, planet deposit, and pop traits
country_event = {
	id = lrsk_gov_var_shroud_touched.1
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_origin = lrsk_gov_var_origin_shroud_touched
	}

	immediate = {
		set_country_flag = lrsk_gov_var_shroud_touched_nation

		add_research_option = tech_psionic_theory
		add_tech_progress = {
			tech = tech_psionic_theory
			progress = 0.05
		}

		# Tag species as being a shroud-touched origin. Not sure if useful...
		species = { set_species_flag = lrsk_gov_var_shroud_touched_species }
		
		# At this stage, randomly sets some to Latent Psychic.
		every_owned_pop = { pop_event = { id = lrsk_gov_var_shroud_touched.3 } }

		capital_scope ={
			if = {
				limit = { owner = { has_origin = lrsk_gov_var_origin_shroud_touched } } # probably redundant but eh

				set_planet_flag = lrsk_gov_var_shroud_touched_capital

				add_deposit = d_lrsk_gov_var_shroud_pockets
			}
		}
	}
}

#Catches pop growth on planet
planet_event = {
	id = lrsk_gov_var_shroud_touched.2
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		#fromfrom = { species = { has_species_flag = lrsk_gov_var_shroud_touched_species } }
		fromfrom = { pop_has_trait = lrsk_gov_var_trait_natural_esper } }
	}

	immediate = {
		if = {
			limit = { fromfrom = { pop_has_trait = lrsk_gov_var_trait_natural_esper } } # probably redundant but eh
			fromfrom = { pop_event = { id = lrsk_gov_var_shroud_touched.3 } }
		}
	}

}

# Handles traits on pops
pop_event = {
	id = lrsk_gov_var_shroud_touched.3
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		#species = { has_species_flag = lrsk_gov_var_shroud_touched_species }
		pop_has_trait = lrsk_gov_var_trait_natural_esper
	}

	immediate = {
		if = {
			limit = { pop_has_trait = lrsk_gov_var_trait_natural_esper } # probably redundant but eh
			if = { 
				limit = {  
					or = {
						owner = { has_ascension_perk = ap_mind_over_matter } #REMOVE the esper trait if they have started real psychic ascension 
						owner = { has_ascension_perk = ap_transcendence } #REMOVE the esper trait if reached next step of real psychic ascension
					}
					or = {
						pop_has_trait = trait_latent_psionic
						pop_has_trait = trait_psionic
					}
				}
				modify_species = {
					species = this
					remove_trait = lrsk_gov_var_trait_natural_esper
				}
				owner = { if = { limit = { NOT = { has_country_flag = lrsk_gov_var_shroud_touched_esper_undone } } country_event = { id = lrsk_gov_var_shroud_touched.4 } } } # in this case, we have to remove them ALL.
			}
			else = {
				# Usually do nothing, occasionally spawn without esper, but rarely promote pop to latent psychic
				random_list = {
					60 = { } 
					5 = { 
						modify_species = { 
							species = this
							remove_trait = lrsk_gov_var_trait_natural_esper
							add_trait = trait_latent_psionic
						} 
					}
					35 = {
						modify_species = { 
							species = this
							remove_trait = lrsk_gov_var_trait_natural_esper
						} 
					}
				}
			}
		}
	}
}

# Attempt to change species after ascension.
country_event = {
	id = lrsk_gov_var_shroud_touched.4
	hide_window = yes
	is_triggered_only = yes
	#fire_only_once = yes

	trigger = {
		or = { 
			has_ascension_perk = ap_mind_over_matter
			has_ascension_perk = ap_transcendence
		}
		has_country_flag = lrsk_gov_var_shroud_touched_nation
		NOT = { has_country_flag = lrsk_gov_var_shroud_touched_esper_undone }
	}

	immediate = {
		if = {
			limit = { or = {
				has_ascension_perk = ap_mind_over_matter
				has_ascension_perk = ap_transcendence
			} }
			every_owned_pop = {
				if = { 
					limit = {
						pop_has_trait = lrsk_gov_var_trait_natural_esper
						#species = { has_species_flag = lrsk_gov_var_shroud_touched_species }
						or = {
							pop_has_trait = trait_latent_psionic
							pop_has_trait = trait_psionic
						}
					}
					modify_species = {
						species = this
						remove_trait = lrsk_gov_var_trait_natural_esper
					}
				}
			}

			modify_species = {
				species = this
				remove_trait = lrsk_gov_var_trait_natural_esper
			}

			set_country_flag = lrsk_gov_var_shroud_touched_esper_undone
		}
	}
}